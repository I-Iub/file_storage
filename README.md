# Проектное задание пятого спринта

## Описание задания

Реализовать **http-сервис**, который обрабатывает поступающие запросы. Сервер 
стартует по адресу `http://127.0.0.1:8080` (дефолтное значение, может быть 
изменено).

<details>
<summary> Список необходимых эндпоинтов </summary>

1. Статус активности связанных сервисов

```
GET /ping
```
Получить информацию о времени доступа ко всем связанным сервисам, например, к 
БД, кэшам, примонтированным дискам и т.д.

**Response**
```json
{
    "db": 1.27,
    ...
}
```

2. Регистрация пользователя.

```
POST /register
```
Регистрация нового пользователя. Запрос принимает на вход логин и пароль для 
создания новой учетной записи.


3. Авторизация пользователя.

```
POST /auth
```
Запрос принимает на вход логин и пароль учетной записи и возвращает 
авторизационный токен. Далее все запросы проверяют наличие токена в 
заголовках - `Authorization: Bearer <token>`


4. Информация о загруженных файлах

```
GET /files/
```
Вернуть информацию о ранее загруженных файлах. Доступно только авторизованному 
пользователю.

**Response**
```json
{
    "account_id": "AH4f99T0taONIb-OurWxbNQ6ywGRopQngc",
    "files": [
          {
            "id": "a19ad56c-d8c6-4376-b9bb-ea82f7f5a853",
            "name": "notes.txt",
            "created_ad": "2020-09-11T17:22:05Z",
            "path": "/homework/test-folder/notes.txt",
            "size": 8512
          },
        ...
          {
            "id": "113c7ab9-2300-41c7-9519-91ecbc527de1",
            "name": "tree-picture.png",
            "created_ad": "2019-06-19T13:05:21Z",
            "path": "/homework/work-folder/environment/tree-picture.png",
            "size": 1945
          }
    ]
}
```


5. Загрузить файл в хранилище

```
POST /files/upload
```
Метод загрузки файла в хранилище. Доступно только авторизованному пользователю.
Для загрузки заполняется полный путь до файла, в который будет 
загружен/переписан загружаемый файл. Если нужные директории не существуют, то 
они должны быть созданы автоматически.
Так же, есть возможность указать только путь до директории. В этом случае имя 
создаваемого файла будет создано в соответствии с передаваемым именем файла.

**Request**
```
{
    "path": <full-path-to-file>||<path-to-folder>,
}
```

**Response**
```json
{
    "id": "a19ad56c-d8c6-4376-b9bb-ea82f7f5a853",
    "name": "notes.txt",
    "created_ad": "2020-09-11T17:22:05Z",
    "path": "/homework/test-folder/notes.txt",
    "size": 8512
}
```


6. Скачать загруженный файл

```
GET /files/download
```
Скачивание ранее загруженного файла. Доступно только авторизованному 
пользователю.

**Path parameters**
```
/?path=<path-to-file>||<file-meta-id>
```
Возможность скачивания есть как по переданному пути до файла, так и по 
идентификатору.


7. Добавление возможности скачивания в архиве

<summary> Описание изменений </summary>

```
GET /files/download
```
Path-параметр расширяется дополнительным параметром - `compression`. Доступно 
только авторизованному пользователю.

Дополнительно в `path` можно указать как путь до директории, так и его 
**UUID**. При скачивании директории будут скачиваться все файлы, находящиеся 
в нем.

**Path parameters**
```
/?path=[<path-to-file>||<file-meta-id>||<path-to-folder>] & 
compression"=[zip||tar]
```
</details>


## Запуск проекта

Клонируйте проект
```
git clone https://github.com/I-Iub/async-python-sprint-5.git
```

Перейдите в папку с проектом, создайте виртуальное окружение и активируйте 
его. python 3.10, ubuntu:
```
python3 -m venv venv
. venv/bin/activate
```
Установите зависимости. Можно пропустить, если не планируется запуск приложения 
вне docker-контейнера. Зависимости также нужны для запуска тестов.
```
pip install --upgrade pip
pip install -r requirements.txt
```

В корневой директории проекта создайте файл с переменными окружения `.env` 
(см. пример -- `.env.example`). Укажите в нём переменную `STORAGE_ROOT_DIR` 
-- путь к папке на хосте, в которую будут сохраняться файлы (хранилище).

Запустите проект
```
docker compose up -d
```

Выполните миграции:
```
docker compose exec api alembic upgrade head
```
Проверьте, что сервис работает. Например, выполните:
```
curl 127.0.0.1:80/api/v1/ping
```
Ответ должен быть примерно такой: `{"db":0.013777}`.

## Запуск тестов

Создайте тестовую базу данных. Например, можно создать её в docker-контейнере:
```
docker run \
  --rm   \
  --name postgres-fastapi-tests \
  -p 65432:5432 \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgres \
  -e POSTGRES_DB=urls \
  -d postgres:14.5
```
Если вы используете базу данных с другими параметрами, то исправьте 
соответствующим образом переменную `DSN` в файле `pytest.ini`, а также 
`DSN_TEST` в файле `.env`.
Укажите в файле `pytest.ini` переменную `STORAGE_ROOT_DIR` -- путь до 
тестового файлового хранилища.

Проверьте, что установлены зависимости (`pip install -r requirements.txt`).

Проверьте, что находитесь в корневой директории проекта, запустите тесты:
```
PYTHONPATH=. pytest src/tests/* -v
```
